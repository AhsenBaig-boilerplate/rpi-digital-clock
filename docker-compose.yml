version: '2.1'

services:
  clock:
    build: .
    privileged: true
    restart: always
    network_mode: host
    
    # Environment variables for configuration
    environment:
      # Native renderer (Rust) enabled by default for performance
      - NATIVE_TIME_RENDERER=true
      - NATIVE_TIME_BIN=/app/native/clock_fb_rust/clock_fb_rust
      
      # Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
      - LOG_LEVEL=INFO
      
      # Timezone setting (e.g., America/New_York, Europe/London, Asia/Tokyo)
      # See https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
      # Commented out to allow settings-ui to control this value
      # - TIMEZONE=America/New_York
      
      # Weather API settings (override config.yaml)
      # Get your free API key at https://openweathermap.org/api
      # Note: Leave these uncommented if you want to use device variables instead of settings-ui
      - WEATHER_API_KEY=
      - WEATHER_LOCATION=New York,US
      - WEATHER_UNITS=metric
      # - WEATHER_ENABLED=true
      
      # Time format settings
      # - TIME_FORMAT_12H=true
      # - SHOW_SECONDS=true
      # - DATE_FORMAT=%A, %B %d, %Y
      
      # Display customization (for native renderer)
      # Commented out to allow settings-ui to control these values
      # - COLOR=#00FF00
      # - TIME_SIZE=280
      # - DATE_SIZE=90
      # - FONT_PATH=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf
      # - DISPLAY_ORIENTATION=landscape  # landscape or portrait
      # - FONT_FAMILY=Helvetica
      
      # Auto-shrink time to fit width (prevents cropping)
      - AUTO_SHRINK_TIME=true
      
      # Screen burn-in prevention
      - PIXEL_SHIFT_ENABLED=true
      - PIXEL_SHIFT_TIME_ENABLED=false
      - PIXEL_SHIFT_INTERVAL_SECONDS=60
      # - SCREENSAVER_ENABLED=true
      # - SCREENSAVER_START_HOUR=2
      # - SCREENSAVER_END_HOUR=5
      # - DIM_AT_NIGHT=true
      # - NIGHT_BRIGHTNESS=0.3
      # - NIGHT_START_HOUR=22
      # - NIGHT_END_HOUR=6
    
    # Labels for balena cloud
    labels:
      io.balena.features.dbus: '1'
      io.balena.features.kernel-modules: '1'
      io.balena.features.firmware: '1'
      io.balena.features.balena-api: '1'
      io.balena.features.supervisor-api: '1'
    
    # Volume mounts
    volumes:
      # Persist configuration changes (shared with settings-ui)
      - 'clock-config:/data'
    
    # Device access for display and optional hardware
    # All devices mounted so features can be enabled via env vars without redeployment
    devices:
      - "/dev/fb0:/dev/fb0"       # Framebuffer (required)
      - "/dev/input:/dev/input"   # Input devices (touch/mouse support)
      - "/dev/i2c-1:/dev/i2c-1"  # I2C for RTC module (only used if RTC_ENABLED=true)
      - "/dev/rtc0:/dev/rtc0"     # RTC device (only used if RTC_ENABLED=true)

  # WiFi Connect service - DISABLED due to D-Bus RsnFlags compatibility issues on RPi Zero
  # D-Bus error: "Get org.freedesktop.NetworkManager.AccessPoint::RsnFlags property failed"
  # Alternative: Use settings-UI (port 8080) WiFi Configuration section instead
  # Requires API_TOKEN device variable for persistent WiFi changes
  # wifi-connect:
  #   build: ./wifi-connect
  #   restart: on-failure
  #   network_mode: host
  #   privileged: true
  #   labels:
  #     io.balena.features.dbus: '1'
  #     io.balena.features.firmware: '1'
  #   cap_add:
  #     - NET_ADMIN
  #   environment:
  #     DBUS_SYSTEM_BUS_ADDRESS: "unix:path=/host/run/dbus/system_bus_socket"

  # Settings UI service - custom web interface for clock configuration
  settings-ui:
    build:
      context: ./settings-ui
      dockerfile: Dockerfile
    restart: always
    network_mode: host
    environment:
      PORT: "8080"
      # Security: Set SETTINGS_PASSWORD to require authentication (recommended!)
      # If not set, anyone on WiFi can access settings without password
      SETTINGS_PASSWORD: ""  # Set this to enable password protection!
      # Enable access to host NetworkManager via DBus for WiFi scanning
      DBUS_SYSTEM_BUS_ADDRESS: "unix:path=/host/run/dbus/system_bus_socket"
    labels:
      io.balena.features.supervisor-api: '1'
      io.balena.features.balena-api: '1'
      io.balena.features.dbus: '1'
    volumes:
      - 'clock-config:/data'  # Shared with clock service
      # Host DBus is provided via io.balena.features.dbus label

volumes:
  clock-config:
