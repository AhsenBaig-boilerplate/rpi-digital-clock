name: Deploy to balena

run-name: "${{ github.event.head_commit.message }}"

on:
  push:
    tags:
      - 'v*'

jobs:
  balena_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history including tags

      - name: Get version from Git
        id: version
        run: |
          # We're always on a tag since workflow only triggers on tag pushes
          VERSION="${GITHUB_REF_NAME}"
          BASE_VERSION="${VERSION}"
          
          echo "Deploying version: ${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT
          
          # Compute display version (strip 'v' prefix)
          DV_NO_V="${VERSION#v}"
          echo "display_version=${DV_NO_V}" >> $GITHUB_OUTPUT

      - name: Annotate workflow with version
        run: |
          # Get commit subject line
          SUBJECT=$(git log -1 --pretty=%s)
          DV_NO_V="${{ steps.version.outputs.display_version }}"
          TITLE="${DV_NO_V}: ${SUBJECT}"
          
          # Display prominently at top of workflow summary
          echo "# ðŸš€ ${TITLE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${DV_NO_V}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Message:** ${SUBJECT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create workflow annotation
          echo "::notice title=${DV_NO_V}::${SUBJECT}"

      - name: Compute release title
        id: release_title
        run: |
          # Get commit subject line
          SUBJECT=$(git log -1 --pretty=%s)
          DV_NO_V="${{ steps.version.outputs.display_version }}"
          TITLE="${DV_NO_V}: ${SUBJECT}"
          echo "Computed release title: $TITLE"
          echo "title=${TITLE}" >> $GITHUB_OUTPUT

      - name: Generate build-info.json (embedded in image)
        run: |
          mkdir -p app
          cat > app/build-info.json <<JSON
          {
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref_name }}",
            "repo": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "git_version": "${{ steps.version.outputs.version }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          JSON
          echo "Embedded build-info.json:" && cat app/build-info.json

      - name: Update balena.yml with version
        run: |
          # Use base version without +rev suffix (balena adds that automatically)
          sed -i "s/<version>/${{ steps.version.outputs.base_version }}/g" balena.yml
          cat balena.yml

      - name: Deploy to balena
        uses: balena-io/deploy-to-balena-action@master
        id: build
        with:
          balena_token: ${{ secrets.BALENA_TOKEN }}
          fleet: ${{ secrets.BALENA_FLEET }}

      - name: Log release info
        run: |
          echo "Built release ID: ${{ steps.build.outputs.release_id }}"
          echo "Release version: ${{ steps.build.outputs.version }}"
          echo "Git version: ${{ steps.version.outputs.version }}"

      - name: Install jq and balena CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g balena-cli --production --unsafe-perm
          balena version

      - name: Login to balena (CLI)
        env:
          BALENA_TOKEN: ${{ secrets.BALENA_TOKEN }}
        run: |
          balena login --token "$BALENA_TOKEN"

      - name: Tag balena release with GitHub info
        if: steps.build.outputs.release_id
        env:
          RELEASE_ID: ${{ steps.build.outputs.release_id }}
        run: |
          echo "Tagging release $RELEASE_ID with GitHub metadata"
          balena tag set --release "$RELEASE_ID" git.sha "${{ github.sha }}"
          balena tag set --release "$RELEASE_ID" git.ref "${{ github.ref_name }}"
          balena tag set --release "$RELEASE_ID" github.run_id "${{ github.run_id }}"
          balena tag set --release "$RELEASE_ID" github.run_url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Write build-metadata.json (artifact)
        run: |
          cat > build-metadata.json <<JSON
          {
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref_name }}",
            "repo": "${{ github.repository }}",
            "run_id": "${{ github.run_id }}",
            "run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "git_version": "${{ steps.version.outputs.version }}",
            "balena_release_id": "${{ steps.build.outputs.release_id }}",
            "balena_release_version": "${{ steps.build.outputs.version }}"
          }
          JSON
          echo "Build metadata artifact: " && cat build-metadata.json

      - name: Upload build metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata
          path: build-metadata.json

      - name: Create GitHub Release with prefixed title
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.release_title.outputs.title }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
