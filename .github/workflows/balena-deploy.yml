name: Deploy to balena

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  balena_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history including tags
          fetch-tags: true  # Explicitly fetch all tags

      - name: Get version from Git
        id: version
        run: |
          # List all tags for debugging
          echo "Available tags:"
          git tag -l
          
          # Try to get the current tag
          VERSION=$(git describe --tags --exact-match 2>/dev/null || echo "")
          
          if [ -z "$VERSION" ]; then
            # Not on a tag, get the latest tag and add commit info
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
            COMMIT_COUNT=$(git rev-list --count ${LATEST_TAG}..HEAD 2>/dev/null || echo "1")
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${LATEST_TAG}+rev${COMMIT_COUNT}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION}"

      - name: Update balena.yml with version
        run: |
          sed -i "s/<version>/${{ steps.version.outputs.version }}/g" balena.yml
          echo "Updated balena.yml with version: ${{ steps.version.outputs.version }}"
          cat balena.yml

      - name: Install balena CLI
        run: |
          npm install -g balena-cli

      - name: Deploy to balena with CLI
        id: build
        run: |
          # Login to balena
          balena login --token ${{ secrets.BALENA_TOKEN }}
          
          # Deploy using balena push (automatically uses git and preserves tags)
          balena push ${{ secrets.BALENA_FLEET }}

      - name: Log release info
        run: |
          echo "Git version: ${{ steps.version.outputs.version }}"
